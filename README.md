## NHN KCP 백엔드 사전과제

**지원자: 함석호**

- [1.기술 스택](#1-기술-스택)
- [2. API와 ERD](#2-api-와-erd)
    - [2.1 API](#21-api)
    - [2.1 API](#22-erd-사진)
- [3. 실행 방법](#3-실행-방법)
- [4. 시스템 설계](#4-시스템-설계)
- [5. 추가적인 의사결정](#5-추가적인-의사결정)
- [6. 테스트 목록 및 결과](#6-테스트-목록-및-결과)
- [7. 개선할 사항](#7-개선할-사항)

---

## 1. 기술 스택

- `Java 17`
- `Spring Boot 3.4.3`
- `H2`
- `JPA`
- `Redis`

## 2. API 와 ERD

#### 2.1 API
- 서버 실행 후 http://localhost:8080/docs/index.html 로 접근하시면 확인하실 수 있습니다. 아래는 일부 사진입니다.

<img width="800" alt="Image" src="https://github.com/user-attachments/assets/673f85aa-4ea4-4353-8679-7b7805b4ef53" />

#### 2.2 ERD 사진

- 해당 ERD에서의 참조 관계는 논리적으로만 참조하고 실제 구현에서는 단순 ID 값만 저장하고 있도록 구현하였습니다.

![ERD](https://github.com/user-attachments/assets/08d685b3-6bcb-4eed-a902-7e3836096178)

## 3. 실행 방법

#### 1. Redis 환경 구축을 위해 docker 폴더에 있는 docker-compose.yml 실행

```shell
# 프로젝트 루트 경로 기준
cd docker
docker-compose up -d
```

#### 2. 스프링부트 서버 실행 (profile은 local로 설정해주세요.)

```shell
# 프로젝트 루트 경로 기준
mvn clean verify spring-boot:run -Dspring-boot.run.profiles=local
```

#### 3. 간단한 API 실행

http 폴더에 쉽게 실행할 수 있는 유저 케이스들을 만들어두었습니다.
필요하시다면 실행해서 확인하실 수 있습니다.

## 4. 시스템 설계

#### 전체 플로우 설계안

최종 설계안이지만 이와 같이 구현은 하지 못했습니다. 하지만 추후 개선한다면 최종적으로 이런 방향성으로 개선할 것 같습니다.

- 대량의 요청을 처리할때 성능 문제가 발생하지 않을 수 있도록 이벤트 구조로 접근하였습니다. 
- 이벤트 구조를 사용하면 요청 처리를 기다리는 시간 자체가 짧아지기 때문에 개별 서버마다 처리할 수 있는 요청의 수가 늘어날 것이라고 생각합니다.  
동시에 요청이 몰리더라도 Queue를 사용하여 처리할 수 있는 수준으로만 요청을 받아 순차적으로 처리하도록 설계하였습니다.
  ![image](https://github.com/user-attachments/assets/00c951dd-4145-4c10-bcaa-4a9b63bb928d)

#### 재고 관리

- 많은 유저가 하나의 상품에 몰릴 경우 동시성 문제가 생길 수 있을거라고 생각합니다.
- 이를 해결하기 위해 순차 처리를 보장하는 Redis 인메모리 저장소를 사용하여 재고를 관리하기로 결정하였습니다.
    - 결제가 완료되기 전까지는 원본 데이터인 DB의 재고를 업데이트하지 않습니다.
    - 결제가 완료된 후 주문의 상태와 DB의 재고 데이터를 최종적으로 업데이트 합니다.

#### 인메모리와 DB의 정합성

- 스케줄러 혹은 배치 잡을 설정하여 가주문 상태로 일정 시간이 지난 주문건들은 취소처리를 하고 인메모리 DB의 데이터를 업데이트할 수 있을것 같습니다.
- 동일한 방식으로 일정 주기마다 DB와 인메모리 저장소의 재고를 교차검증하여 정합성을 맞출 수 있을것 같습니다.

![image](https://github.com/user-attachments/assets/84a356b0-ba0b-4788-91cc-f9980e18307b)

## 5. 추가적인 의사결정

- 의도치 않은 추가 쿼리 실행 혹은 변경 발생을 방지하고 필수적인 관계는 아니라고 생각하여 연관관계를 맺는 대신 단순 Long 타입의 Id를 사용하여 Entity를 구현하였습니다.
- 재고 관리 로직에서 순차 처리 및 원자성 보장을 위해 LuaScript를 사용하였습니다.
- 테스트 환경 격리를 위하여 TestContainers를 사용하였습니다.

## 6. 테스트 목록 및 결과

### 1. E2E 테스트

<img width="500" alt="Image" src="https://github.com/user-attachments/assets/20e90257-52e6-4952-bdb4-2947982e3a8a" />

### 2. 통합 테스트

<img width="500" alt="Image" src="https://github.com/user-attachments/assets/5153cf29-ad0c-43b0-b9ee-c283fd1d45bd" />


## 7. 개선할 사항
- 설계 방향대로 각각의 서비스를 별개의 서버로 분리하는 작업을 진행하고, 이벤트 구조를 도입해볼 예정입니다.
- 이벤트 구조에서는 어떻게 테스트를 작성할 수 있는지 학습하고 적용할 예정입니다.
